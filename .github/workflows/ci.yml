name: CI

on:
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "lib/**"
      - "scripts/**"
      - "tests/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - "package.json"
      - "package-lock.json"
      - "build.rs"
      - "deno.json"
      - "deno.lock"
      - "tsconfig*.json"
      - "Taskfile.yml"
      - "rust-toolchain.toml"
      - ".github/workflows/ci.yml"
  pull_request:
    branches:
      - main
    paths:
      - "src/**"
      - "lib/**"
      - "scripts/**"
      - "tests/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - "package.json"
      - "package-lock.json"
      - "build.rs"
      - "deno.json"
      - "deno.lock"
      - "tsconfig*.json"
      - "Taskfile.yml"
      - "rust-toolchain.toml"
      - ".github/workflows/ci.yml"

jobs:
  build-and-test:
    name: Build and Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: Linux
          - os: macos-latest
            name: macOS
          - os: windows-latest
            name: Windows
    env:
      PRINTERS_JS_SIMULATE: true # Force simulation mode for all tests
      CARGO_TERM_COLOR: always
    permissions: {}
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      # Linux-specific setup
      - name: Disable man-db auto-update and install CUPS libraries (Linux)
        if: runner.os == 'Linux'
        run: |
          echo "man-db man-db/auto-update boolean false" | sudo debconf-set-selections
          sudo rm -f /var/lib/man-db/auto-update
          sudo apt-get update
          sudo apt-get install -y libcups2-dev pkg-config clang

      # Setup Rust toolchain for building native library
      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      # Cache Rust dependencies for faster builds
      - uses: Swatinem/rust-cache@v2
        with:
          prefix-key: ${{ matrix.os }}-rust

      # Install cargo-llvm-cov for code coverage (Linux only)
      # Coverage artifacts only uploaded from Linux to avoid duplicates
      - name: Install cargo-llvm-cov (Linux only)
        if: runner.os == 'Linux'
        uses: taiki-e/install-action@cargo-llvm-cov

      # Setup Deno
      - uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x

      # Setup Bun
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Task runner
        uses: go-task/setup-task@v1

      # Setup Node.js
      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 20

      # Install Node.js dependencies
      - name: Install Node.js dependencies
        run: npm install

      # Build all runtime libraries (includes compilation)
      - name: Build all runtime libraries
        run: task build

      # Run comprehensive cross-runtime tests (includes Rust, Deno, Node.js, Bun)
      # This generates JUnit XML and LCOV coverage for all runtimes
      - name: Run cross-runtime tests
        id: cross-runtime-tests
        run: task test

      - name: Upload Test Reports
        if: ${{ always() }}
        uses: actions/upload-artifact@v6
        with:
          name: test-reports-${{ matrix.name }}
          path: test-results/*.xml
          if-no-files-found: ignore

      - name: Upload Coverage Reports (Linux only)
        if: ${{ always() && runner.os == 'Linux' }}
        uses: actions/upload-artifact@v6
        with:
          name: coverage-reports
          path: test-results/coverage/*
          if-no-files-found: ignore
